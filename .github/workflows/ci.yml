name: Aegisub CI

on:
    workflow_dispatch:
        inputs:
            version:
                description: 'Release version'
                required: true

env:
    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    TZ: Asia/Shanghai

jobs:
    build:
        name: ${{ matrix.config.name }}
        runs-on: ${{ matrix.config.os }}

        strategy:
            fail-fast: false
            matrix:
                config:
                    -   name: Windows MSVC Release
                        os: windows-latest
                        msvc: true
                        buildtype: release
                        args: >-
                            -Ddefault_library=static
                            --force-fallback-for=zlib,harfbuzz,freetype2,fribidi,libpng
                            -Dfreetype2:harfbuzz=disabled
                            -Dharfbuzz:freetype=disabled
                            -Dharfbuzz:cairo=disabled
                            -Dharfbuzz:glib=disabled
                            -Dharfbuzz:gobject=disabled
                            -Dharfbuzz:tests=disabled
                            -Dharfbuzz:docs=disabled
                            -Dharfbuzz:icu=disabled
                            -Dfribidi:tests=false
                            -Dfribidi:docs=false
                            -Dlibass:fontconfig=disabled
                            -Dffmpeg:libdav1d=enabled
                            -Davisynth=enabled
                            -Dbestsource=enabled
                            -Dvapoursynth=enabled
        steps:
            -   name: set current date
                id: set_date
                run: |
                    date=$(date -d '+8 hour' +'%Y-%m')
                    echo "date=$date" >> $GITHUB_OUTPUT
                shell: bash
            -   uses: actions/checkout@v4
                with:
                    fetch-depth: '0'

            -   name: cache Aegisub build
                id: Aegisub_cache
                uses: actions/cache@v4
                with:
                    path: |
                        D:\a\Aegisub\Aegisub\build
                        D:\a\Aegisub\Aegisub\subprojects
                    key: Aegisub-build-${{ steps.set_date.outputs.date }}
                    restore-keys: Aegisub-build-

            -   name: delete git_version.h
                run: |
                    ls -lah /d/a/Aegisub/Aegisub/subprojects
                    rm -f /d/a/Aegisub/Aegisub/build/git_version.h
                shell: bash

            -   uses: actions/setup-python@v5
                with:
                    python-version: '3.x'

            -   name: Setup Meson
                run: |
                    python -m pip install --upgrade pip setuptools
                    pip install meson

            -   name: Setup MSVC
                if: matrix.config.os == 'windows-latest' && matrix.config.msvc == true
                uses: ilammy/msvc-dev-cmd@v1

            -   name: Install dependencies (Windows)
                if: matrix.config.os == 'windows-latest'
                run: |
                    choco install ninja innosetup
                    
                    $moonscripturl = "https://github.com/leafo/moonscript/releases/download/win32-v0.5.0/moonscript-187bac54ee5a7450013e9c38e005a0e671b76f45.zip"
                    mkdir moonscript
                    Invoke-WebRequest -Uri $moonscripturl -OutFile ".\moonscript\moonscript.zip"
                    pushd moonscript
                    7z e moonscript.zip
                    Get-Location | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                    popd
                    
                    $gettexturl = "https://github.com/mlocati/gettext-iconv-windows/releases/download/v0.21-v1.16/gettext0.21-iconv1.16-static-64.zip"
                    Invoke-WebRequest -Uri $gettexturl -OutFile ".\gettext.zip"
                    Expand-Archive ".\gettext.zip" -DestinationPath gettext
                    pushd gettext/bin
                    Get-Location | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
                    popd

            -   name: Generate version header
                run: |
                    powershell -File tools/version.ps1 -BuildRoot build -VersionOverride "${{ github.event.inputs.version }}"

            -   name: Read version header
                id: read_version
                run: |
                    $version_content = Get-Content "build/git_version.h" -Raw
                    if ($version_content -match '#define INSTALLER_VERSION "([^"]+)"') {
                        $installer_version = $matches[1]
                        echo "INSTALLER_VERSION=$installer_version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
                        Write-Host "Version from git_version.h: $installer_version"
                    }
                shell: pwsh

            -   name: Configure
                if: steps.Aegisub_cache.outputs.cache-hit != 'true'
                run: |
                    $meson_args = "${{ matrix.config.args }}"
                    # 使用传入的版本号或环境变量中读取的版本号
                    if (\"${{ github.event.inputs.version }}\" -ne \"\") {
                        $version = \"${{ github.event.inputs.version }}\"
                    } elseif (\"$env:INSTALLER_VERSION\" -ne \"\") {
                        $version = \"$env:INSTALLER_VERSION\"
                    }
                    if ($version) {
                        $meson_args += \" -Dversion=$version\"
                        Write-Host \"Using version: $version\"
                    }
                    meson setup build $meson_args -Dbuildtype=${{ matrix.config.buildtype }}
                    meson configure build
                shell: pwsh

            -   name: Build
                run: meson compile -C build -j(Get-WmiObject -Class Win32_Processor).NumberOfLogicalProcessors

            #            -   name: Run test
            #                run: meson test -C build --verbose "gtest main"

            # Windows artifacts
            -   name: Generate Windows installer
                if: matrix.config.os == 'windows-latest'
                env:
                    AEGISUB_VERSION: ${{ github.event.inputs.version }}
                run:
                    meson compile win-installer -C build -j(Get-WmiObject -Class Win32_Processor).NumberOfLogicalProcessors

            -   name: Generate Windows portable
                if: matrix.config.os == 'windows-latest'
                run: meson compile win-portable -C build -j(Get-WmiObject -Class Win32_Processor).NumberOfLogicalProcessors

            -   name: set release tag
                id: set_tag
                run: |
                    mv build/Aegisub-*.exe build/aegisub-install-64.exe
                    if [ -n "${{ github.event.inputs.version }}" ]; then
                        echo "tag=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
                    else
                        date=$(date -d '+8 hour' +'%Y-%m-%d %H:%M')
                        echo "tag=$date" >> $GITHUB_OUTPUT
                    fi
                shell: bash

            -   name: Upload artifacts - win_installer
                uses: actions/upload-artifact@v4
                if: matrix.config.os == 'windows-latest'
                with:
                    name: ${{ matrix.config.name }} - installer
                    path: build/aegisub-install-64.exe
                    if-no-files-found: error

            -   name: Upload artifacts - portable.zip
                uses: actions/upload-artifact@v4
                if: matrix.config.os == 'windows-latest'
                with:
                    name: ${{ matrix.config.name }} - portable
                    path: build/aegisub-portable-64.zip

            -   name: create Release
                uses: ncipollo/release-action@v1.14.0
                with:
                    allowUpdates: true
                    artifacts: "build/aegisub-portable-64.zip,build/aegisub-install-64.exe"
                    tag: ${{ steps.set_tag.outputs.tag }}
                    draft: true
